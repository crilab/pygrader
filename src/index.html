<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width">
        <title>Web Template</title>
        <style>

            html, body {
                margin: 0;
                padding: 0;
                height: 100%;
            }

            #content {
                background-color: white;
                height: 100%;
                display: flex;
            }

            #leftPanel {
                flex: 1;
                display: flex;
                flex-direction: column;
                padding: 25px;
            }

            #source {
                flex: 1;
                resize: none;
                margin: 25px;
            }

            #rightPanel {
                font-family: sans-serif;
                font-size: 10px;
                color: white;
                background-color: #111111;
                flex: 1;
                border-left: 1px solid black;
            }

            #rightPanel > div,
            #rightPanel > pre {
                margin: 0;
                margin-bottom: 15px;
                background-color: #222222;
                padding: 15px;
                border-top: 1px solid black;
                border-bottom: 1px solid black;
            }

        </style>
    </head>
    <body>
        <iframe id="sandbox" sandbox="allow-scripts" style="display: none;" srcdoc="
            <html><head><script>

                window.onload = function() {
                    const workerCode = `
                        importScripts('https://cdn.jsdelivr.net/pyodide/v0.27.5/full/pyodide.js')

                        function post(type, data) {
                            self.postMessage({type, data})
                        }

                        async function initializePyodide() {
                            self.pyodide = await loadPyodide()
                            self.pyodide.setStdout({
                                batched: msg => {
                                    post('stdout', msg)
                                }
                            })
                            self.pyodideReady = true
                            post('ready', '')
                        }

                        self.onmessage = async function(e) {
                            if (!self.pyodideReady)
                                return
                            try {
                                const globals = self.pyodide.toPy({})
                                const locals = self.pyodide.toPy({})
                                self.pyodide.globals.set(
                                    'result',
                                    self.pyodide.runPython(e.data, {globals, locals})
                                )
                                post(
                                    'exec_complete',
                                    self.pyodide.runPython('import json; json.dumps(result)')
                                )
                            } catch(error) {
                                post('stdout', error.message)
                                post('exec_error', 'crash')
                            }
                        }

                        initializePyodide()
                    `

                    const blob = new Blob([workerCode], {type: 'application/javascript'})
                    const workerUrl = URL.createObjectURL(blob)
                    const worker = new Worker(workerUrl)

                    worker.onmessage = function(e) {
                        window.parent.postMessage(e.data, '*')
                    }

                    window.addEventListener('message', function(e) {
                        worker.postMessage(e.data)
                    })
                }

            </script></head></html>
        "></iframe>

        <script>
            class PythonRuntime {
                #statusEventListeners

                #execTimeout
                #execStdoutCounter
                #execResolve
                #execReject
                #exec(type, data, newResolve = undefined) {
                    clearTimeout(this.#execTimeout)
                    switch (type) {
                        case 'resolve':
                            this.#execResolve(data)
                            break
                        case 'reject':
                            this.#execReject(data)
                            break
                    }
                    this.#execResolve = newResolve
                    this.#execReject = undefined
                }

                constructor() {
                    if (window.python) return window.python

                    this.#execResolve = 'not ready'

                    window.addEventListener('message', event => {
                        if (event.source !== this.#getElement('sandbox').contentWindow) return
                        this.#windowMessage(event.data)
                    })

                    this.#statusEventListeners = []
                    window.python = this
                }

                addStatusEventListener(callback) {
                    this.#statusEventListeners.push(callback)
                }

                #publishStatusEvent(ready) {
                    this.#statusEventListeners.map(cb => cb(ready))
                }

                #sandboxReset(execRejectMsg) {
                    const sandbox = this.#getElement('sandbox')
                    const srcdoc = sandbox.srcdoc
                    sandbox.srcdoc = ''
                    sandbox.srcdoc = srcdoc
                    this.#exec('reject', execRejectMsg, 'not ready')
                }

                #getElement(id) {
                    if (!['output', 'sandbox'].includes(id))
                        throw Error('Not a valid element: ' + id)
                    return document.getElementById(id)
                }

                #output(msg) {
                    this.#getElement('output').textContent += msg + '\n'
                }

                #windowMessage(event) {
                    if (['not ready', undefined].includes(this.#execResolve)) {
                        if (event.type == 'ready') {
                            this.#execResolve = undefined
                            this.#publishStatusEvent('ready')
                        }
                        return
                    }

                    console.log(event)

                    switch (event.type) {
                        case 'stdout':
                            this.#execStdoutCounter += 1
                            if (this.#execStdoutCounter <= 100)
                                this.#output(event.data)
                            else
                                this.#sandboxReset('spam')
                            break
                        case 'exec_complete':
                            this.#exec('resolve', event.data)
                            break
                        case 'exec_error':
                            this.#exec('reject', event.data)
                            break

                    }
                }

                async run(code) {
                    if (this.#execResolve) throw Error('Python is busy.')

                    const execPromise = new Promise((resolve, reject) => {
                        this.#execResolve = resolve
                        this.#execReject = reject
                    })

                    this.#execStdoutCounter = 0
                    this.#getElement('sandbox').contentWindow.postMessage(code, '*')
                    this.#execTimeout = setTimeout(() => { this.#sandboxReset('timeout') }, 1000)
                    return await execPromise
                }
            }
            new PythonRuntime()
        </script>

        <div id="content">
            <div id="leftPanel">
                <div id="description"></div>
                <textarea id="source"></textarea>
            </div>
            <div id="rightPanel">
                <div id="buttons"><button id="run">Run</button></div>
                &nbsp;Anrop:
                <pre id="call"></pre>
                &nbsp;Facit (JSON):
                <pre id="solution"></pre>
                &nbsp;Returvärde (JSON): <span id="gradeReturn"></span>
                <pre id="return"></pre>
                &nbsp;Utskrift: <span id="gradeOutput"></span>
                <pre id="output"></pre>
            </div>
        </div>

        <script>
            class Assignment {
                #funcName
                #argsGenerator
                #argsCurrent
                #solution
                #solutionCurrent

                constructor(description, funcName, argsGenerator, solution) {
                    if (window.assignment) return window.assignment

                    document.getElementById('description').innerHTML = description.replace('%NAME%', `<strong>${funcName}</strong>`)
                    this.#funcName = funcName
                    this.#argsGenerator = argsGenerator
                    this.#solution = solution

                    window.python.addStatusEventListener((ready) => {
                        if (ready)
                            this.#newTestCase()
                    })

                    window.assignment = this
                }

                #getElement(id) {
                    return document.getElementById(id)
                }

                async #newTestCase() {
                    this.#argsCurrent = this.#argsGenerator()
                    this.#getElement('call').innerText += this.#getCall()
                    this.#solutionCurrent = await window.python.run(
                        this.#solution + '\n\n' + this.#getCall()
                    )
                    this.#getElement('solution').innerText = this.#solutionCurrent
                }

                #getCall() {
                    let call = this.#funcName + '('
                    this.#argsCurrent.forEach(arg => {
                        arg = '\n' + JSON.stringify(arg, null, 2)
                        arg = arg.replaceAll('\n', '\n  ')
                        call += arg + ','
                    })
                    return call.slice(0, -1) + '\n)'
                }

                async test(source) {
                    this.#getElement('return').innerText = ' '
                    this.#getElement('output').innerText = ''

                    source += '\n\n' + this.#getCall()
                    const result = await window.python.run(source)

                    this.#getElement('return').innerText = ''
                    for (let i = 0; i < result.length; i++) {
                        const span = document.createElement('span')
                        span.innerText = result[i]
                        span.style.color = 'green'
                        if (result[i] !== this.#solutionCurrent[i])
                            span.style.color = 'red'
                        this.#getElement('return').appendChild(span)
                    }

                    let grade = true

                    if (result === this.#solutionCurrent) {
                        this.#getElement('gradeReturn').innerText = '✅'
                    } else {
                        this.#getElement('gradeReturn').innerText = '❌'
                        grade = false
                    }

                    if (this.#getElement('output').innerHTML === '') {
                        this.#getElement('gradeOutput').innerText = '✅'
                    } else {
                        this.#getElement('gradeOutput').innerText = '❌'
                        grade = false
                    }

                    return grade
                }
            }

            new Assignment(
                '<p>Definiera en funktion %NAME% som tar två heltal som argument.</p><p>Funktionen ska returnera summan av de två heltalen.</p>',
                'double',
                () => {
                    const args = []
                    while (args.length < 2) {
                        args.push(Math.floor(Math.random() * 2000) - 1000)
                    }
                    return args
                },
                `def double(a, b):
                    return a + b`
            )

            const sandbox = document.getElementById('sandbox')
            const source = document.getElementById('source')
            const run = document.getElementById('run')
            const output = document.getElementById('output')

            run.addEventListener('click', async function() {
                window.assignment.test(source.value)
            })
        </script>
    </body>
</html>
