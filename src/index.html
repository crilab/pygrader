<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width">
        <title>Web Template</title>
    </head>
    <body>
        <iframe id="sandbox" sandbox="allow-scripts" style="display: none;" srcdoc="
            <html><head><script>

                window.onload = function() {
                    const workerCode = `
                        importScripts('https://cdn.jsdelivr.net/pyodide/v0.27.5/full/pyodide.js')

                        function post(type, data) {
                            if (data === undefined)
                                data = null
                            self.postMessage({type, data})
                        }

                        async function initializePyodide() {
                            self.pyodide = await loadPyodide()
                            self.pyodide.setStdout({
                                batched: msg => {
                                    post('stdout', msg)
                                }
                            })
                            self.pyodideReady = true
                            post('ready', '')
                        }

                        self.onmessage = async function(e) {
                            if (!self.pyodideReady)
                                return
                            try {
                                post('exec_complete', self.pyodide.runPython(e.data))
                            } catch(error) {
                                post('exec_error', error.message)
                            }
                        }

                        initializePyodide()
                    `

                    const blob = new Blob([workerCode], {type: 'application/javascript'})
                    const workerUrl = URL.createObjectURL(blob)
                    const worker = new Worker(workerUrl)

                    worker.onmessage = function(e) {
                        window.parent.postMessage(e.data, '*')
                    }

                    window.addEventListener('message', function(e) {
                        worker.postMessage(e.data)
                    })
                }

            </script></head></html>
        "></iframe>

        <script>
            class PythonRuntime {
                #execResolve
                #execReject
                #exec(type, data) {
                    switch (type) {
                        case 'resolve':
                            this.#execResolve(data)
                            break
                        case 'reject':
                            this.#execReject(data)
                            break
                    }
                    this.#execResolve = undefined
                    this.#execReject = undefined
                }

                constructor() {
                    if (window.python) return window.python

                    this.#execResolve = 'not ready'

                    window.addEventListener('message', event => {
                        if (event.source !== this.#getElement('sandbox').contentWindow) return
                        this.#windowMessage(event.data)
                    })

                    window.python = this
                }

                #getElement(id) {
                    if (!['output', 'sandbox'].includes(id))
                        throw Error('Not a valid element: ' + id)
                    return document.getElementById(id)
                }

                #output(msg) {
                    this.#getElement('output').textContent += msg + '\n'
                }

                #windowMessage(event) {
                    console.log(event)
                    switch (event.type) {
                        case 'ready':
                            this.#execResolve = undefined
                            break
                        case 'stdout':
                            this.#output(event.data)
                            break
                        case 'exec_complete':
                            this.#exec('resolve', event.data)
                            break
                        case 'exec_error':
                            this.#output(event.data)
                            this.#exec('reject', 'crash')
                            break

                    }
                }

                async run(code) {
                    if (this.#execResolve) throw Error('Python is busy.')

                    const execPromise = new Promise((resolve, reject) => {
                        this.#execResolve = resolve
                        this.#execReject = reject
                    })

                    this.#getElement('sandbox').contentWindow.postMessage(code, '*')
                    return await execPromise
                }
            }
            new PythonRuntime()
        </script>

        <textarea id="src"></textarea>
        <button id="run">Run</button>
        <pre id="output"></pre>

        <script>
            const sandbox = document.getElementById('sandbox')
            const src = document.getElementById('src')
            const run = document.getElementById('run')
            const output = document.getElementById('output')

            run.addEventListener('click', async function() {
                console.warn(await window.python.run(src.value))
            })
        </script>
    </body>
</html>
